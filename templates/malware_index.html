<html>

<head>
   <title>Platforme d'Analyse de Malware</title>
   <link rel="stylesheet" href="{{ url_for('static', filename='index.css') }}">
</head>

<body>
   <div class="container">
      <div class="header">
         <h1>Platforme d'Analyse de Malware</h1>
         <p>Télécharger les fichiers suspects pour une analyse sécurisée</p>
      </div>

      <div class="upload-container">
         <form id="uploadForm" action="/analyze" method="post" enctype="multipart/form-data">
            <div class="file-input-wrapper">
               <input type="file" name="file" id="fileInput" accept=".exe,.dll,.bin" required>
               <p>Glissez-déposer votre fichier ici ou clickez sur Parcourir</p>
            </div>

            <div class="progress-bar" id="progressBar">
               <div class="progress" id="progress"></div>
            </div>

            <button type="submit" class="upload-btn">Analyse du fichier</button>
         </form>
      </div>

      <div class="result-container" id="resultContainer">
         <div class="status-icon" id="statusIcon"></div>
         <h2 id="resultTitle"></h2>
         <p id="resultMessage"></p>
      </div>
   </div>

   <script>
      document.getElementById('uploadForm').addEventListener('submit', function (e) {
         e.preventDefault();

         const fileInput = document.getElementById('fileInput');
         const progressBar = document.getElementById('progressBar');
         const progress = document.getElementById('progress');
         const resultContainer = document.getElementById('resultContainer');
         const resultTitle = document.getElementById('resultTitle');
         const resultMessage = document.getElementById('resultMessage');
         const statusIcon = document.getElementById('statusIcon');

         if (fileInput.files.length === 0) {
            alert('Please select a file');
            return;
         }

         const file = fileInput.files[0];
         if (file.size > 10 * 1024 * 1024) { // 10MB limit
            alert('File size exceeds 10MB limit');
            return;
         }

         // Show progress bar
         progressBar.style.display = 'block';

         const formData = new FormData(this);

            fetch('/malware_test', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                progressBar.style.display = 'none';
                resultContainer.style.display = 'block';
            
                if (data.y_pred == 0) {
                    resultContainer.className = 'result-container result-clean';
                    statusIcon.innerHTML = '✅';
                    resultTitle.textContent = "Le fichier n'a révélé aucune menace";
                    resultMessage.textContent = "Aucun logiciel malveillant n'a été détecté dans ce fichier.";
                } else {
                    resultContainer.className = 'result-container result-malware';
                    statusIcon.innerHTML = '⚠️';
                    resultTitle.textContent = 'Malware Détecté';
                    resultMessage.textContent = 'Ce fichier a été identifié comme un logiciel malveillant. Manipulez-le avec prudence !';
                }
            })
            .catch(error => {
                progressBar.style.display = 'none';
                alert('Error analyzing file: ' + error.message);
            });


         // Simulate progress bar animation
         let width = 0;
         const interval = setInterval(() => {
            if (width >= 90) {
               clearInterval(interval);
            } else {
               width += 5;
               progress.style.width = width + '%';
            }
         }, 200);
      });

      // Drag and drop functionality
      const dropZone = document.querySelector('.file-input-wrapper');

      dropZone.addEventListener('dragover', (e) => {
         e.preventDefault();
         dropZone.style.borderColor = '#21CBF3';
      });

      dropZone.addEventListener('dragleave', (e) => {
         e.preventDefault();
         dropZone.style.borderColor = '#2196F3';
      });

      dropZone.addEventListener('drop', (e) => {
         e.preventDefault();
         dropZone.style.borderColor = '#2196F3';
         const files = e.dataTransfer.files;
         document.getElementById('fileInput').files = files;
      });
   </script>
</body>

</html>